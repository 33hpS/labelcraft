#!/usr/bin/env node
/**
 * Cloudflare D1 Database Backup Script
 * Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· D1 Ğ² SQL dump
 */

import { exec } from 'child_process';
import { promisify } from 'util';
import fs from 'fs/promises';
import path from 'path';
import { fileURLToPath } from 'url';

const execAsync = promisify(exec);
const __dirname = path.dirname(fileURLToPath(import.meta.url));

// ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ
const CONFIG = {
  databaseName: 'productlabelerpro',
  databaseId: '6bcefdbd-4109-4545-b521-d42694b7144c',
  backupDir: path.join(__dirname, '../backups'),
  retentionDays: 30, // Ğ¥Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ±ÑĞºĞ°Ğ¿Ñ‹ 30 Ğ´Ğ½ĞµĞ¹
};

/**
 * Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ´Ğ»Ñ Ğ±ÑĞºĞ°Ğ¿Ğ¾Ğ²
 */
async function ensureBackupDir() {
  try {
    await fs.access(CONFIG.backupDir);
  } catch {
    await fs.mkdir(CONFIG.backupDir, { recursive: true });
    console.log(`âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ° Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ´Ğ»Ñ Ğ±ÑĞºĞ°Ğ¿Ğ¾Ğ²: ${CONFIG.backupDir}`);
  }
}

/**
 * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ²ÑĞµÑ… Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†
 */
async function getTables() {
  try {
    const { stdout } = await execAsync(
      `npx wrangler d1 execute ${CONFIG.databaseName} --command "SELECT name FROM sqlite_master WHERE type='table' ORDER BY name"`
    );
    
    // ĞŸĞ°Ñ€ÑĞ¸Ğ½Ğ³ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ° wrangler (JSON Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚)
    const lines = stdout.split('\n').filter(line => line.trim());
    const tables = [];
    
    for (const line of lines) {
      try {
        const parsed = JSON.parse(line);
        if (parsed.name && !parsed.name.startsWith('sqlite_') && !parsed.name.startsWith('d1_')) {
          tables.push(parsed.name);
        }
      } catch {
        // Ğ˜Ğ³Ğ½Ğ¾Ñ€Ğ¸Ñ€ÑƒĞµĞ¼ ÑÑ‚Ñ€Ğ¾ĞºĞ¸, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ½Ğµ JSON
      }
    }
    
    return tables;
  } catch (error) {
    console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ ÑĞ¿Ğ¸ÑĞºĞ° Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†:', error.message);
    return [];
  }
}

/**
 * Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹
 */
async function exportTable(tableName) {
  try {
    const { stdout } = await execAsync(
      `npx wrangler d1 execute ${CONFIG.databaseName} --command "SELECT * FROM ${tableName}"`
    );
    
    // ĞŸĞ°Ñ€ÑĞ¸Ğ½Ğ³ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
    const lines = stdout.split('\n').filter(line => line.trim());
    const rows = [];
    
    for (const line of lines) {
      try {
        rows.push(JSON.parse(line));
      } catch {
        // Ğ˜Ğ³Ğ½Ğ¾Ñ€Ğ¸Ñ€ÑƒĞµĞ¼ Ğ½Ğµ-JSON ÑÑ‚Ñ€Ğ¾ĞºĞ¸
      }
    }
    
    return rows;
  } catch (error) {
    console.error(`âŒ ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ° Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹ ${tableName}:`, error.message);
    return [];
  }
}

/**
 * Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ SQL INSERT Ğ¸Ğ· Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
 */
function generateInserts(tableName, rows) {
  if (rows.length === 0) return '';
  
  const inserts = [];
  
  for (const row of rows) {
    const columns = Object.keys(row);
    const values = columns.map(col => {
      const val = row[col];
      if (val === null) return 'NULL';
      if (typeof val === 'string') return `'${val.replace(/'/g, "''")}'`;
      return val;
    });
    
    inserts.push(
      `INSERT INTO ${tableName} (${columns.join(', ')}) VALUES (${values.join(', ')});`
    );
  }
  
  return inserts.join('\n');
}

/**
 * Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ SQL dump
 */
async function createBackup() {
  console.log('ğŸš€ ĞĞ°Ñ‡Ğ¸Ğ½Ğ°ĞµĞ¼ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ±ÑĞºĞ°Ğ¿Ğ°...\n');
  
  await ensureBackupDir();
  
  const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
  const backupFile = path.join(CONFIG.backupDir, `backup-${timestamp}.sql`);
  
  let sqlDump = `-- Cloudflare D1 Database Backup
-- Database: ${CONFIG.databaseName}
-- Date: ${new Date().toISOString()}
-- Generated by: backup-d1.mjs

SET FOREIGN_KEYS = 0;

`;
  
  // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†
  console.log('ğŸ“‹ ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ ÑĞ¿Ğ¸ÑĞºĞ° Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†...');
  const tables = await getTables();
  
  if (tables.length === 0) {
    console.log('âš ï¸  Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹ Ğ¸Ğ»Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ');
    return;
  }
  
  console.log(`âœ… ĞĞ°Ğ¹Ğ´ĞµĞ½Ğ¾ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†: ${tables.length}\n`);
  
  // Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ĞºĞ°Ğ¶Ğ´ÑƒÑ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñƒ
  for (const table of tables) {
    console.log(`ğŸ“¦ Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹: ${table}...`);
    
    const rows = await exportTable(table);
    
    if (rows.length > 0) {
      sqlDump += `\n-- Table: ${table} (${rows.length} rows)\n`;
      sqlDump += `DELETE FROM ${table};\n`;
      sqlDump += generateInserts(table, rows);
      sqlDump += '\n\n';
      console.log(`   âœ… Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾ ${rows.length} Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹`);
    } else {
      console.log(`   âš ï¸  Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° Ğ¿ÑƒÑÑ‚Ğ°`);
    }
  }
  
  sqlDump += '\nSET FOREIGN_KEYS = 1;\n';
  
  // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ² Ñ„Ğ°Ğ¹Ğ»
  await fs.writeFile(backupFile, sqlDump, 'utf-8');
  
  const stats = await fs.stat(backupFile);
  const sizeKB = (stats.size / 1024).toFixed(2);
  
  console.log(`\nâœ… Ğ‘ÑĞºĞ°Ğ¿ ÑĞ¾Ğ·Ğ´Ğ°Ğ½ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾!`);
  console.log(`ğŸ“ Ğ¤Ğ°Ğ¹Ğ»: ${backupFile}`);
  console.log(`ğŸ“Š Ğ Ğ°Ğ·Ğ¼ĞµÑ€: ${sizeKB} KB`);
  
  // ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° ÑÑ‚Ğ°Ñ€Ñ‹Ñ… Ğ±ÑĞºĞ°Ğ¿Ğ¾Ğ²
  await cleanupOldBackups();
}

/**
 * Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ°Ñ€Ñ‹Ğµ Ğ±ÑĞºĞ°Ğ¿Ñ‹
 */
async function cleanupOldBackups() {
  try {
    const files = await fs.readdir(CONFIG.backupDir);
    const now = Date.now();
    const maxAge = CONFIG.retentionDays * 24 * 60 * 60 * 1000;
    
    let deleted = 0;
    
    for (const file of files) {
      if (!file.startsWith('backup-') || !file.endsWith('.sql')) continue;
      
      const filePath = path.join(CONFIG.backupDir, file);
      const stats = await fs.stat(filePath);
      const age = now - stats.mtimeMs;
      
      if (age > maxAge) {
        await fs.unlink(filePath);
        deleted++;
        console.log(`ğŸ—‘ï¸  Ğ£Ğ´Ğ°Ğ»Ñ‘Ğ½ ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹ Ğ±ÑĞºĞ°Ğ¿: ${file}`);
      }
    }
    
    if (deleted > 0) {
      console.log(`\nğŸ§¹ Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¾ ÑÑ‚Ğ°Ñ€Ñ‹Ñ… Ğ±ÑĞºĞ°Ğ¿Ğ¾Ğ²: ${deleted}`);
    }
  } catch (error) {
    console.error('âš ï¸  ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ¸ ÑÑ‚Ğ°Ñ€Ñ‹Ñ… Ğ±ÑĞºĞ°Ğ¿Ğ¾Ğ²:', error.message);
  }
}

/**
 * Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ¸Ğ· Ğ±ÑĞºĞ°Ğ¿Ğ°
 */
async function restoreBackup(backupFile) {
  console.log(`ğŸ”„ Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¸Ğ· Ğ±ÑĞºĞ°Ğ¿Ğ°: ${backupFile}\n`);
  
  try {
    const sql = await fs.readFile(backupFile, 'utf-8');
    
    // Ğ Ğ°Ğ·Ğ±Ğ¸Ñ‚ÑŒ Ğ½Ğ° Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹
    const commands = sql.split(';').filter(cmd => cmd.trim() && !cmd.trim().startsWith('--'));
    
    console.log(`ğŸ“ ĞĞ°Ğ¹Ğ´ĞµĞ½Ğ¾ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´: ${commands.length}`);
    
    for (let i = 0; i < commands.length; i++) {
      const cmd = commands[i].trim();
      if (!cmd) continue;
      
      try {
        await execAsync(
          `npx wrangler d1 execute ${CONFIG.databaseName} --command "${cmd.replace(/"/g, '\\"')}"`
        );
        
        if ((i + 1) % 10 === 0) {
          console.log(`   âœ… Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¾ ${i + 1}/${commands.length} ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´...`);
        }
      } catch (error) {
        console.error(`   âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ ${i + 1}:`, error.message);
      }
    }
    
    console.log('\nâœ… Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¾!');
  } catch (error) {
    console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ:', error.message);
  }
}

// CLI
const args = process.argv.slice(2);
const command = args[0];

if (command === 'restore' && args[1]) {
  restoreBackup(args[1]);
} else if (command === 'restore') {
  console.error('âŒ Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ Ñ„Ğ°Ğ¹Ğ» Ğ´Ğ»Ñ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ: npm run backup:restore <file>');
} else {
  createBackup();
}
