# Руководство по работе с заказами

## Обзор

Страница "Заказы на печать" позволяет импортировать производственные задания из Excel и контролировать печать этикеток с квотами.

## Основной рабочий процесс

### 1. Импорт заказа из Excel

1. Откройте страницу "Заказы на печать" в меню навигации
2. В разделе "Импорт из Excel" нажмите "Выбрать файл"
3. Выберите файл производственного задания (формат `.xlsx` или `.xls`)
4. Система автоматически обработает файл:
   - Найдет секцию "Продукция"
   - Извлечет наименования и количества
   - Покажет предварительный просмотр импортируемых данных
5. Проверьте данные в таблице предпросмотра
6. Нажмите "Импортировать" для создания заказа

**Требования к формату Excel:**

- Файл должен содержать секцию с заголовком "Продукция"
- Столбец с общим количеством должен называться "Общее Кол-во" или подобным образом
- Импорт останавливается при встрече секции "Материалы"

### 2. Выбор шаблона

1. В верхней части страницы выберите шаблон этикетки из выпадающего списка
2. Шаблон будет использоваться для всех печатей в текущем заказе
3. Активный шаблон отмечен галочкой ✓

### 3. Работа с позициями заказа

После импорта заказ появится в списке слева. Нажмите на него для загрузки позиций.

#### Привязка товаров

1. Для каждой позиции выберите соответствующий товар из выпадающего списка в колонке "Товар"
2. Система автоматически сохранит привязку
3. Без привязки товара печать невозможна

#### Печать этикеток

1. Убедитесь, что:
   - Выбран шаблон
   - Товар привязан к позиции
   - Остаток > 0
2. Нажмите кнопку "Печать"
3. Откроется окно печати с готовой этикеткой
4. После печати счетчики автоматически обновятся

**Система квот:**

- Каждой позиции разрешено напечатать ровно столько этикеток, сколько указано в плане
- После печати остаток уменьшается на 1
- Когда остаток = 0, печать блокируется
- Для дополнительных печатей требуется разрешение администратора

### 4. Дополнительные печати (Администратор)

Если требуется напечатать больше этикеток, чем указано в заказе:

1. Нажмите кнопку "Доп. печать" для нужной позиции
2. В диалоговом окне укажите:
   - **Количество дополнительных печатей** (например, 5)
   - **Администраторский ключ** (секретный пароль)
3. Нажмите "Разрешить"
4. При правильном ключе квота увеличится
5. Новые этикетки можно будет напечатать как обычно

**Примечание:** Администраторский ключ настраивается в переменных окружения Worker (`ADMIN_KEY` в `wrangler.toml`).

## Информационная панель

Правая панель "Текущий статус" показывает:

- **Название** выбранного заказа
- **Осталось** — общий остаток непечатанных этикеток
- **Напечатано** — сколько этикеток уже напечатано
- **Статусные сообщения** — результаты операций (успех/ошибка)

## Таблица позиций

Колонки:

- **Наименование** — название позиции из Excel
- **План** — запрошенное количество из Excel
- **Печатано** — сколько этикеток напечатано
- **Доп.** — сколько дополнительных печатей разрешено администратором
- **Остаток** — доступно для печати (план + доп. - печатано)
- **Товар** — привязка к товару из базы данных
- **Действия** — кнопки печати и запроса дополнительных печатей

## Частые вопросы

**В: Можно ли изменить количество в уже импортированном заказе?**
О: Нет, заказ после импорта не изменяется. Используйте функцию дополнительных печатей или импортируйте новый заказ.

**В: Что делать, если товар не найден автоматически?**
О: Выберите его вручную из выпадающего списка в колонке "Товар".

**В: Печать не работает, кнопка неактивна.**
О: Проверьте:

1. Выбран ли шаблон в верхней части страницы
2. Привязан ли товар к позиции
3. Остаток > 0

**В: Что делать, если забыли администраторский ключ?**
О: Ключ указан в конфигурации Worker (`wrangler.toml`, переменная `ADMIN_KEY`). Обратитесь к администратору системы.

**В: Можно ли напечатать несколько этикеток сразу?**
О: Сейчас печать происходит по одной этикетке за раз. Для массовой печати можно несколько раз нажать кнопку "Печать" (в пределах квоты).

## Технические детали

### API эндпоинты

- `GET /api/orders` — список заказов
- `GET /api/orders/:id` — детали заказа с позициями
- `POST /api/orders/import` — импорт нового заказа
- `PUT /api/orders/:orderId/items/:itemId` — обновление позиции
- `POST /api/orders/:orderId/items/:itemId/print` — проверка квоты и учет печати
- `POST /api/orders/:orderId/items/:itemId/allow-extra` — разрешение дополнительных печатей (требует админ-ключ)

### База данных

Таблицы:

- `orders` — основная информация о заказах
- `order_items` — позиции заказов с количествами и счетчиками

### Интеграция

- Использует общий модуль `src/lib/labelPrinter.ts` для рендеринга и печати этикеток
- Работает со всеми существующими шаблонами и товарами
- Автоматическое обновление счетчиков после каждой операции
